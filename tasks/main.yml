---
- name: Create registry data path
  file:
    path: "{{ docker_registry_path }}"
    state: directory

- name: Create registry config
  copy:
    src: "{{ docker_registry_config_file }}"
    dest: "{{ docker_registry_path }}/config.yml"

- name: Create docker-compose.yml
  template:
    src: "{{ docker_registry_compose_file }}"
    dest: "{{ docker_registry_path }}/docker-compose.yml"

# NOTE: docker-compose writes stdout to stderr (don't know why?, but just use 2>&1 for now)
#       also we have no option and need to check output with color which doesn't make sense at all
- name: Start registry container
  shell: docker-compose up -d --remove-orphans 2>&1
  args:
    chdir: "{{ docker_registry_path }}"
  register: docker_compose_up
  changed_when: |
    "Creating registry ... \u001b[32mdone\u001b[0m" in docker_compose_up.stdout or
    "Recreating registry ... \u001b[32mdone\u001b[0m" in docker_compose_up.stdout or
    "Starting registry ... \u001b[32mdone\u001b[0m" in docker_compose_up.stdout
  